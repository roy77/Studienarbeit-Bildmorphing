<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Morphing Demonstrator</title>
</head>
<header>
    <style>
        .bottom-right {
            position: fixed;
            bottom: 0;
            right: 0;
            padding: 1px;
            font-size: 18px;
        }

        .top-right {
            position: fixed;
            top: 0;
            right: 0;

        }

        .top-centerd {
            position: fixed;
            top: 0;
            right: 0;

        }

        .top-centered {
			text-align: center;
		}

        #meldung 
        {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 10px;
            background-color: #f2f2f2;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 0 5px #999;
            }
    </style>
</header>
<body>
<h1 class="top-centered">Bildmorphing Demonstrator</h1>
<a class="bottom-right" href="https://github.com/ThomasHennefeld/Studienarbeit-Bildmorphing">Autor: Thomas Hennefeld</a>
<img  src="DHBW_Logo.jpg" alt="DHBW Logo" title="DHBW" width="150" class='top-right' >
<div>  
    <!--Canvas-Elemente-->  
    <canvas id="QuellCanvas"  style="border:2px solid #000000;" alt='bitte die Seite neuladen' title="Thomas Hennefeld"></canvas>   
    <canvas id="ZielCanvas"  style="border:2px solid #000000;" alt='bitte die Seite neuladen' title="Viktor Trott"></canvas> 
    <canvas id="maskCanvas"  style="border:2px solid #000000;"></canvas>
    <canvas id="Ausgabecanvas"  style="border:2px solid  #000000; display:none"></canvas>
</div>
<div id="meldung" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 10px; background-color: #1ce30a; border: 1px solid #cccccc; border-radius: 5px; box-shadow: 0 0 5px #999;"></div>

<button type="button1" id="btn1" onclick="MorphingDurchführen()">Morphing</button>
<input type="range" min="0" max="4" value="0" class="slider" id="slider1">
<input type="range" min="0" max="7" value="0" class="slider" id="slider2"><span id="sliderValue"></span>

<div>  
    <canvas id="Ergebniscanvas_0"  style="display:none;"></canvas>
    <canvas id="Ergebniscanvas_1"  style="display:none;"></canvas>   
    <canvas id="Ergebniscanvas_2"  style="display:none;"></canvas>
    <canvas id="Ergebniscanvas_3"  style="display:none;"></canvas>   
    <canvas id="Ergebniscanvas_4"  style="display:none;"></canvas>
</div>


<!--<button type="button2" id="btn2" onclick="Gesichtserkennung()">Gesichterkennung</button>-->
<!--<button type="button2" id="btn2" onclick="KoordinatenAbspeichern()">Koordinaten abspeichern</button>-->

<!--<script src="dlib.js"></script> -->
<script src="Punkt_Klasse.js"></script>
<script src="BildBox_Klasse.js"></script>
<script src="Morphing_Klasse.js"></script>
<script src="Gesichtserkennung.js"></script>                 
<script src="opencv.js" id="opencvjs"></script> 

<script>
    //Deklaration
    var Morphs = [];
    var Zwischencanvas = [];
    var Ergebniscanvas = [];
    var Gewichtung = [0.25, 0.5, 0.75]; //Gewichtungsvektor für die Bildüberlagerung
    var Morphing1;
    var n=3; //Anzahl Zwischennetze
    let BildBox1= new BildBox();
    let BildBox2= new BildBox();
    var transformierteQuellbilder = [];
    var transformierteZielbilder = [];

    function start()
    {   

      //Koordinaten sind im x,y-Format gespeichert
      var QuellStartKoordinaten = [0,0, 58.25,0, 116.5,0, 174.75,0, 233,0, 0,79.75, 68,73, 114,75, 168,75, 233,79.75, 0,159.5, 83,165,
      120,168, 157,168, 233,159.5, 0,239.25, 85,243, 125,245, 158,241, 233,239.25, 0,319, 58.25,319, 116.5,319, 174.75,319, 233,319]; 
      var ZielStartKoordinaten = [0,0, 58.25,0, 116.5,0, 174.75,0, 233,0, 0,79.75, 56,61, 105,67, 154,56, 233,79.75, 0,159.5, 63,147,
      99,144, 147,144, 233,159.5, 0,239.25, 76,235, 101,237, 131,233, 233,239.25, 0,319, 58.25,319, 116.5,319, 174.75,319, 233,319];

      var Ausgabecanvas = document.getElementById('Ausgabecanvas');
      var AusgabeCtx = Ausgabecanvas.getContext('2d');

      var slider1 = document.getElementById("slider1");
      var slider2 = document.getElementById("slider2");
      var output = document.getElementById("sliderValue");
      output.innerHTML = "";
      
      //Namensdeklaration der Canvas
      for(let i=0; i<=5; i++)
      {
          Ergebniscanvas[i] = "Ergebniscanvas_" + i;
      }

      //Bilder müssen die gleiche Größe haben
      BildBox1.init('QuellCanvas','Thomas_1_zugeschnitten.png', QuellStartKoordinaten);
      BildBox2.init('ZielCanvas','Viktor_1_zugeschnitten.png', ZielStartKoordinaten);

      //Morphing1 erstellen und initialisieren 
      Morphing1=(new Morphing()).init('TransformationsCanvas','maskCanvas', BildBox1.Punkte, BildBox2.Punkte);

      //Morphing initial starten -> nicht sinnvoll, da lange Laufzeit

      //Uebergabe-Event auffangen und Daten an Morphing1 übergeben
      addEventListener('Uebergabe', function (e) 
      {
          let info=e.detail;
          Morphing1.uebertragen(info.sender, info.Punkte, info.teilverhältnis);
      }, false);

      //Slider1 für die Morphs
      slider1.oninput = function() 
      {
          output.innerHTML = "Ergebnisbild: " +this.value; 
          Ausgabecanvas.style.display = 'inline';
          cv.imshow(Ausgabecanvas, Morphs[this.value]);            
      }

      //Slider2 für die Zwischenbilder
      slider2.oninput = function() 
      {
          output.innerHTML = "Zwischenbild: " +this.value; 
          Ausgabecanvas.style.display = 'inline';
          if(this.value < 4)
              cv.imshow(Ausgabecanvas, transformierteQuellbilder[this.value]);
          if(this.value > 3 && this.value < 8)
              cv.imshow(Ausgabecanvas, transformierteZielbilder[this.value-4]);     
      }
    }
    
    //Funktionen
    //Durchführung des Morphing
    function MorphingDurchführen()
    {   
        //Netzinterpolation
        var Zwischenpunkte = Morphing1.NetzInterpolation(Morphing1.QuellpunkteM, Morphing1.ZielpunkteM, n);

        //Bilder skalieren
        let bildMat1 = cv.imread(BildBox1.bild);
        let bildMat2 = cv.imread(BildBox2.bild);

        //Transformationen
        transformierteQuellbilder[0] = Morphing1.transformiereAusschnitte(Morphing1.QuellpunkteM, Zwischenpunkte[0], bildMat1);
        transformierteQuellbilder[1] = Morphing1.transformiereAusschnitte(Morphing1.QuellpunkteM, Zwischenpunkte[1], bildMat1);
        transformierteQuellbilder[2] = Morphing1.transformiereAusschnitte(Morphing1.QuellpunkteM, Zwischenpunkte[2], bildMat1);
        transformierteQuellbilder[3] = Morphing1.transformiereAusschnitte(Morphing1.QuellpunkteM, Morphing1.ZielpunkteM,bildMat1);

        //Zielbild -> Quellbild 
        transformierteZielbilder[0] = Morphing1.transformiereAusschnitte(Morphing1.ZielpunkteM, Zwischenpunkte[2], bildMat2);
        transformierteZielbilder[1] = Morphing1.transformiereAusschnitte(Morphing1.ZielpunkteM, Zwischenpunkte[1], bildMat2);
        transformierteZielbilder[2] = Morphing1.transformiereAusschnitte(Morphing1.ZielpunkteM, Zwischenpunkte[0], bildMat2);
        transformierteZielbilder[3] = Morphing1.transformiereAusschnitte(Morphing1.ZielpunkteM, Morphing1.QuellpunkteM, bildMat2);

        //Addition der Zwischenbilder
        Morphs[0] = new cv.Mat(); 
        cv.addWeighted(bildMat1, 1, transformierteZielbilder[3], 0, 0, Morphs[0]); 
        cv.imshow(Ergebniscanvas[0],Morphs[0]);

        let j=3;
        for(let i=1; i<=3; i++)
        {    
            j--;
            Morphs[i] = new cv.Mat();
            cv.addWeighted(transformierteQuellbilder[i-1], Gewichtung[j], transformierteZielbilder[j], Gewichtung[i-1], 0, Morphs[i]);
            cv.imshow(Ergebniscanvas[i],Morphs[i]); 
        }
 
        Morphs[4] = new cv.Mat();
        cv.addWeighted(transformierteQuellbilder[3], 0, bildMat2, 1, 0, Morphs[4]);
        cv.imshow(Ergebniscanvas[4],Morphs[4]);

        Ausgabecanvas.style.display = 'inline';
        cv.imshow(Ausgabecanvas, Morphs[2]);

        //Meldetext, sobald Morphing abgeschlossen, da bei großen Skalierungsfaktor lange Laufzeit
        meldungEinblenden("Morphing erfolgreich durchgeführt!", 1500);
    }

    //Meldung einblenden, Zeit: Anzeigedauer
    function meldungEinblenden(text, zeit) 
    {
        var meldungsElement = document.getElementById("meldung");
        meldungsElement.innerText = text;
        meldungsElement.style.display = "block";

        setTimeout(function() {
            meldungsElement.style.display = "none";
        }, zeit);
    }

    //Hilfsfunktion für tiefes Arraykopieren
    function deepCopy(arr)
    {
        let copy = [];
        arr.forEach(elem => {
          if(Array.isArray(elem)){
            copy.push(deepCopy(elem))
          }else{
            if (typeof elem === 'object') {
              copy.push(deepCopyObject(elem))
          } else {
              copy.push(elem)
            }
          }
        })
        return copy;
    }
      
    function deepCopyObject(obj)
    {
        let tempObj = {};
        for (let [key, value] of Object.entries(obj)) {
          if (Array.isArray(value)) {
            tempObj[key] = deepCopy(value);
          } else {
            if (typeof value === 'object') {
              tempObj[key] = deepCopyObject(value);
            } else {
              tempObj[key] = value
            }
          }
        }
        return tempObj;
    }
    
    //Koordinaten abspeichern, für neue Bilder
    function KoordinatenAbspeichern()
    {
        let QuellStartKoordinaten = deepCopy(BildBox1.Punkte);
        let ZielStartKoordinaten = deepCopy(BildBox2.Punkte);
    }

    //waitOpenCV()
    cv['onRuntimeInitialized']=()=>{
      meldungEinblenden("OpenCV erfolgreich geladen!", 1500);    
      start();
    };
    
</script>       
</body>
</html>